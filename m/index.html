<!DOCTYPE html>
<html>
    <head>
        <title>Audio Conference</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="https://code.jquery.com/jquery-2.1.4.min.js" ></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">


        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>

        <!-- scripts used for broadcasting -->
        <script src="https://cdn.webrtc-experiment.com/firebase.js"></script>
        <script src="https://cdn.webrtc-experiment.com/RTCMultiConnection.js"></script>

    </head>
    <body>
        <div class="row">
            <div class="col-xs-1 col-md-3"></div>
            <div class="col-xs-10 col-md-6">
                <h1>모두의 메가폰</h1>
                <br/>
            </div>
            <div class="col-xs-1 col-md-3"></div>
        </div>
        
        <div class="row">
            <div class="col-xs-1 col-md-3"></div>
            <div class="col-xs-10 col-md-6" >
                <button id="btnSpeak" class="setup btn btn-primary btn-block" style="height: 120px">SPEAK</button>
            </div>
            <div class="col-xs-1 col-md-3"></div>
        </div>
        
        <div class="row">
            <div class="col-xs-1 col-md-3"></div>
            <div class="col-xs-10 col-md-6">
                <br/>
            </div>
            <div class="col-xs-1 col-md-3"></div>
        </div>
        
        <div class="row">
            <div class="col-xs-1 col-md-3"></div>
            <div class="col-xs-10 col-md-6">
                <!-- local/remote videos container -->
                <table style="width: 100%;padding: 20px" id="audios-container"></table>
            </div>
            <div class="col-xs-1 col-md-3"></div>
        </div>
    </body>
    <script type="text/javascript">
        

        (function () {
            var uniqueToken = document.getElementById('unique-token');
            if (uniqueToken)
                if (location.hash.length > 2)
                    uniqueToken.parentNode.parentNode.parentNode.innerHTML = '<h2 style="text-align:center;"><a href="' + location.href + '" target="_blank">Share this link</a></h2>';
                else
                    uniqueToken.innerHTML = uniqueToken.parentNode.parentNode.href = '#' + (Math.random() * new Date().getTime()).toString(36).toUpperCase().replace(/\./g, '-');
        })();
        
        $(document).ready(function(){
            var media;
            var audioContainer = document.getElementById('audios-container') || document.body;

            var connection = new RTCMultiConnection();
            connection.session = {
                audio: true
            };

            connection.sdpConstraints.mandatory = {
                OfferToReceiveAudio: true,
                OfferToReceiveVideo: false
            };

            connection.onstream = function (e) {
                console.log("sessionid: "+ connection.sessionid);
                console.log("userid: "+ connection.userid);
                
                console.log(e);
                var tr = document.createElement('tr');
                tr.id = "tr"+e.userid;
                var userContainer;
                if(e.userid==connection.userid){
                    tr.innerHTML = '<td><strong>' + e.userid + '</strong></td>' +
                            '<td id='+e.userid+'></td>';
                    media = e.mediaElement;
                    media.pause();
                    audioContainer.insertBefore(tr, audioContainer.firstChild);
                    userContainer = document.getElementById(e.userid);
                    userContainer.insertBefore(e.mediaElement, userContainer.firstChild);
                }else{
                    tr.innerHTML = '<td>' + e.userid + '</td>' +
                        '<td id='+e.userid+'></td>';
                    audioContainer.insertBefore(tr, audioContainer.firstChild);
                    userContainer = document.getElementById(e.userid);
                    userContainer.insertBefore(e.mediaElement, userContainer.firstChild);
                    e.mediaElement.muted = false;
                }
                
                
            };
            
            connection.onstreamended = function(e){
                $("#tr"+e.userid).remove();
            };

            var sessions = {};
            connection.onNewSession = function (session) {
                if (sessions[session.sessionid])
                    return;
                sessions[session.sessionid] = session;
                if(session.sessionid == "phone") connection.join(session);                
            };
            
            connection.onspeaking = function (e) {
                // e.streamid, e.userid, e.stream, etc.
                e.mediaElement.style.border = '1px solid red';
            };
            /*
            $("#btnSpeak").mousedown(function(e){
                e.currentTarget.blur();
                if(media) media.play();
            });
            $("#btnSpeak").mouseup(function(e){
                e.currentTarget.blur();
                if(media) media.pause();
            });
            */
            $('#btnSpeak').on({ 
                'touchstart' : function(){ if(media) media.play(); },
                'touchend' : function(){ if(media) media.pause(); },
                'mousedown' : function(){ if(media) media.play(); },
                'mouseup' : function(){ if(media) media.pause(); } 
            } );

            // setup signaling to search existing sessions
            connection.connect();
            setTimeout(function(){
                //if don't have session, open to session
                if(Object.keys(sessions).length==0){
                   connection.open('phone');
                }
                else{
                    console.log('Already session opened.');
                }
            }, 5000);
            
        });
    </script>
</html>
